<%- include('partials/layout_start', { title: 'Perfil: ' + user.username }) %>

    <div class="profile-container" style="max-width: 1000px; margin: 0 auto; padding: 2rem;">
        <!-- Profile Header Card -->
        <header class="profile-header-card"
            style="background: white; border-radius: 12px; border: 1px solid var(--border-color); padding: 2.5rem; text-align: center; box-shadow: var(--shadow-sm); margin-bottom: 2rem;">
            <div class="profile-avatar"
                style="width: 100px; height: 100px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 800; margin: 0 auto 1.5rem; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);">
                <%= user.username.charAt(0).toUpperCase() %>
            </div>
            <h1
                style="font-size: 2.25rem; font-weight: 800; color: var(--text-main); margin-bottom: 0.5rem; border: none;">
                <%= user.username %>
            </h1>
            <p style="color: var(--text-muted); font-size: 1rem;">Miembro desde el <%= new
                    Date(user.created_at).toLocaleDateString('es-ES', { day: 'numeric' , month: 'long' , year: 'numeric'
                    }) %>
            </p>

            <div style="margin-top: 1.5rem; display: flex; justify-content: center; gap: 1rem;">
                <% if (currentUser && currentUser.id===user.id) { %>
                    <a href="/logout" class="btn-secondary" style="font-size: 0.875rem;">
                        <i class="ph ph-sign-out"></i> Cerrar Sesión
                    </a>
                    <% } %>
                        <% if (user.role==='admin' ) { %>
                            <span
                                style="background: rgba(99, 102, 241, 0.1); color: var(--primary-color); padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Administrador</span>
                            <% } %>
            </div>
        </header>

        <div class="profile-content-grid" style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem;">
            <!-- Left Column: Stats -->
            <aside class="profile-sidebar">
                <h2 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-main);">
                    Estadísticas de Contribución</h2>
                <div class="stats-stack" style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="stat-item-card"
                        style="background: white; padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border-color);">
                        <div
                            style="color: var(--text-muted); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">
                            Total Contribuciones</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">
                            <%= stats.total_contributions %>
                        </div>
                    </div>
                    <div class="stat-item-card"
                        style="background: white; padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border-color);">
                        <div
                            style="color: var(--text-muted); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">
                            Páginas Creadas</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-main);">
                            <%= stats.pages_count %>
                        </div>
                    </div>
                    <div class="stat-item-card"
                        style="background: white; padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border-color);">
                        <div
                            style="color: var(--text-muted); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">
                            Ediciones Realizadas</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-main);">
                            <%= stats.revisions_count %>
                        </div>
                    </div>
                    <div class="stat-item-card"
                        style="background: white; padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border-color);">
                        <div
                            style="color: var(--text-muted); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">
                            Comentarios</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-main);">
                            <%= stats.comments_count %>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Right Column: Activity Feed -->
            <main class="profile-main">
                <h2 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-main);">
                    Actividad Reciente</h2>
                <div class="profile-activity-timeline" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <% if (activities.length===0) { %>
                        <div class="empty-state"
                            style="background: white; padding: 3rem; border-radius: 12px; border: 1px dashed var(--border-color); text-align: center; color: var(--text-muted);">
                            <i class="ph ph-ghost" style="font-size: 2.5rem; margin-bottom: 1rem; display: block;"></i>
                            Aún no hay actividad registrada.
                        </div>
                        <% } else { %>
                            <% activities.forEach(function(act) { %>
                                <div class="activity-timeline-item"
                                    style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem;">
                                    <div class="activity-icon-circle" style="width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: <%= 
                                act.action_type.includes('created') ? 'rgba(16, 185, 129, 0.1)' : 
                                act.action_type.includes('updated') ? 'rgba(99, 102, 241, 0.1)' : 
                                act.action_type.includes('comment') ? 'rgba(236, 72, 153, 0.1)' : 'var(--bg-main)' %>; 
                                color: <%= 
                                act.action_type.includes('created') ? 'var(--success-color)' : 
                                act.action_type.includes('updated') ? 'var(--primary-color)' : 
                                act.action_type.includes('comment') ? 'var(--magenta)' : 'var(--text-muted)' %>;">
                                        <i class="ph <%= 
                                    act.action_type.includes('created') ? 'ph-plus-circle' : 
                                    act.action_type.includes('updated') ? 'ph-pencil-line' : 
                                    act.action_type.includes('comment') ? 'ph-chat-circle-dots' : 'ph-lightning' %>"
                                            style="font-size: 1.25rem;"></i>
                                    </div>
                                    <div class="activity-details" style="flex: 1; min-width: 0;">
                                        <div style="font-size: 0.875rem; color: var(--text-main); line-height: 1.4;">
                                            <% if (act.action_type==='created_page' ) { %>
                                                Creó la página <a href="/w/<%= act.wiki_slug %>/wiki/<%= act.slug %>"
                                                    style="font-weight: 600; text-decoration: none; color: var(--primary-color);">
                                                    <%= act.title %>
                                                </a>
                                                <% } else if (act.action_type==='updated_page' ) { %>
                                                    Editó <a href="/w/<%= act.wiki_slug %>/wiki/<%= act.slug %>"
                                                        style="font-weight: 600; text-decoration: none; color: var(--primary-color);">
                                                        <%= act.title %>
                                                    </a>
                                                    <% } else if (act.action_type==='commented' ) { %>
                                                        Comentó en <a
                                                            href="/w/<%= act.wiki_slug %>/wiki/<%= act.slug %>"
                                                            style="font-weight: 600; text-decoration: none; color: var(--primary-color);">
                                                            <%= act.title %>
                                                        </a>
                                                        <% } else if (act.action_type==='created_topic' ) { %>
                                                            Creó el tema <strong>
                                                                <%= act.metadata ? JSON.parse(act.metadata).name
                                                                    : 'Nuevo Tema' %>
                                                            </strong>
                                                            <% } else { %>
                                                                Realizó una acción: <strong>
                                                                    <%= act.action_type %>
                                                                </strong>
                                                                <% } %>
                                        </div>
                                        <div
                                            style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                            <span>
                                                <%= new Date(act.created_at).toLocaleDateString() %>
                                            </span>
                                            <span>•</span>
                                            <span style="color: var(--magenta); font-weight: 600;">
                                                <%= act.wiki_slug %>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
                                    <% } %>
                </div>
            </main>
        </div>
    </div>

    <%- include('partials/layout_end') %>